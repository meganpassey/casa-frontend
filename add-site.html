<!doctype html>
<html lang="en">
   <head>
      <title>CaSa CampSafe - Dashboard</title>
      <link rel="stylesheet" type="text/css" href="css/casa.css">
      <link rel="stylesheet" type="text/css" href="semantic/packaged/css/semantic.css">
      <script src="http://code.jquery.com/jquery-latest.min.js"></script>
      <script src="js/sorttable.js"></script>
      <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
      <script src="semantic/packaged/javascript/semantic.js"></script>
      <script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.4/mapbox.js'></script>
      <link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.4/mapbox.css' rel='stylesheet' />
      <style>
         body { overflow: hidden; }
         #map { position:absolute; top:0; bottom:0; width:100%; z-index: 0}
      </style>
   </head>
   <body>
      <link href='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.2.2/leaflet.draw.css' rel='stylesheet' />
      <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.2.2/leaflet.draw.js'></script>
      <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-geodesy/v0.1.0/leaflet-geodesy.js'></script>
      <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-minimap/v1.0.0/Control.MiniMap.js'></script>
      <link href='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-minimap/v1.0.0/Control.MiniMap.css' rel='stylesheet' />
      <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.24.0/L.Control.Locate.js'></script>
      <link href='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.24.0/L.Control.Locate.css' rel='stylesheet' />
      <!--[if lt IE 9]>
      <link href='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.21.0/L.Control.Locate.ie.css' rel='stylesheet' />
      <![endif]-->
      <!--<div class="ui header"><h2>Active Sites</h2></div>!-->
      <div class="ui grid">
         <div class="column">
            <div id="menu" class="ui inverted red menu">
               <a href="dashboard.html" class="item"><i class="tasks icon"></i>Dashboard</a>
               <div class="right menu">
                  <a class="item"><i class="user icon"></i>Username</a>
                  <a class = "item" ><i class="key icon"></i>Log Out</a>
               </div>
            </div>
            <div  id="settings-pane" class="ui form segment">
               <div class="field">
                  <div id="name-input-style" class="ui left labeled input">
                     <input id="name-input" type="text" placeholder="Site Name" required>
                  </div>
               </div>
               <div class="ui error message">
                  <div class="header">We noticed some issues</div>
               </div>
               <div class="ui buttons">
                  <div id="new-button" class="ui button">New</div>
                  <div id="edit-button" class="ui button">Edit</div>
               </div>
               <div id="submit" class="ui disabled red submit button">Submit</div>
            </div>
         </div>
      </div>
      <div id="map">
      </div>
      <script>
         // Provide your access token
         L.mapbox.accessToken = 'pk.eyJ1IjoiYmxhc3Rlcm50IiwiYSI6ImlwalZmdUkifQ.TJCtxxyNmRhvH-17afmGng';
         // Create a map in the div #map
         
         
         map = L.mapbox.map('map', 'blasternt.cddf600d',  {zoomControl: false} );
         
         var geocoder = L.mapbox.geocoder('mapbox.places-v1');
         
         geocoder.query('Geneva, Switzerland', showMap);
         var geocoderControl = L.mapbox.geocoderControl('mapbox.places-v1', {
           keepOpen: true
         });
             
         geocoderControl.addTo(map);
         
         geocoderControl.setPosition( 'bottomright' );
         
         new L.Control.Zoom({ position: 'bottomright' }).addTo(map);
         
         function showMap(err, data) {
           // The geocoder can return an area, like a city, or a
           // point, like an address. Here we handle both cases,
           // by fitting the map bounds to an area or zooming to a point.
           if (data.lbounds) {
               map.fitBounds(data.lbounds);
           } else if (data.latlng) {
               map.setView([data.latlng[0], data.latlng[1]], 13);
           }
         }
         
         var featureGroup = L.featureGroup().addTo(map);
         
         var json; 
         var element;
         
         var polygonDrawer = new L.Draw.Polygon(map, {
               allowIntersection: false, // Restricts shapes to simple polygons
               drawError: {
                   color: '#E4C06C', // Color the shape will turn when intersects
                   message: '<strong>Oopsies<strong> borders can\'t intersect' // Message that will show when intersect
               },
               shapeOptions: {
                   color: '#D94A66'
               }
             }
           );
         
         var editor = new L.EditToolbar.Edit(map, {
                   featureGroup: featureGroup
               })
         
         map.on('draw:created', showPolygonArea);
         map.on('draw:edited', showPolygonAreaEdited);
         
         function showPolygonAreaEdited(e) {
           e.layers.eachLayer(function(layer) {
             showPolygonArea({ layer: layer });
           });
         }
         var polythere = false;
         var submitOk = false;
         function showPolygonArea(e) {
           //e.className="dodged";
           featureGroup.clearLayers();
           featureGroup.addLayer(e.layer);
           e.layer.bindPopup((LGeo.area(e.layer) / 1000000).toFixed(2) + ' km<sup>2</sup>' );
           e.layer.openPopup();
           element = e;
           
           polygonDrawer.disable();
           newActive = false;
           polythere = true;
           $( "#new-button" ).removeClass("active");
           $( "#new-button" ).text('Clear');
           if ($('#name-input').val().length > 0 ) {
             console.log(""+$('#name-input').val().length);
             $( "#submit" ).removeClass("disabled");
             submitOk = true;
           } else {
             $( "#name-input-style" ).addClass("error");
           }
           
         }
         
         //var locator = L.control.locate().addTo(map);
         //locator.setPosition( 'bottomleft' );
         
         //      var minimap = new L.Control.MiniMap(L.mapbox.tileLayer('examples.map-i86nkdio'))
         //            .addTo(map);
         //      
         //      minimap.setPosition( 'bottomright' );
         var newActive = false;
         var editActive = false;
         
         
         $( "#new-button" ).click(function() {
           if(newActive) {
             polygonDrawer.disable();
             newActive = false;
             polythere = false;
             $( "#new-button" ).removeClass("active");
           } else {
             $( "#new-button" ).text('New');
             submitOk = false;
             $( "#submit" ).addClass("disabled");
             featureGroup.clearLayers();
             polygonDrawer.enable();
             newActive = true;
             $( "#new-button" ).addClass("active");
             if(editActive) {
               editor.disable();
               editActive = false;
             $( "#edit-button" ).removeClass("active");
             }
           }
         });
         
         $( "#edit-button" ).click(function() {
           if(editActive) {
             editor.disable();
             editActive = false;
             $( "#edit-button" ).removeClass("active");
           } else {
             editor.enable();
             editActive = true;
             $( "#edit-button" ).addClass("active");
             if(newActive) {
               polygonDrawer.disable();
               newActive = false;
               $( "#new-button" ).removeClass("active");
             }
           }
         });
         
         var inputfilled;
         
         $('#name-input').on('keypress keydown keyup',function(){
           inputfilled = $(this).val().length > 0;
                if (!inputfilled) {
                  submitOk = false; 
                  $( "#submit" ).addClass("disabled");
                } else {
                  $('#name-input-style').removeClass("error");
                  if (polythere) {
                    $( "#submit" ).removeClass("disabled");
                    submitOk = true;
                  }
                }
            });         $('#name-input').on('keypress keydown keyup',function(){
           inputfilled = $(this).val().length > 0;
                if (!inputfilled) {
                  submitOk = false; 
                  $( "#submit" ).addClass("disabled");
                } else {
                  $('#name-input-style').removeClass("error");
                  if (polythere) {
                    $( "#submit" ).removeClass("disabled");
                    submitOk = true;
                  }
                }
            });
         
         $( "#submit" ).click(function() {
           if(submitOk) {
             json = element.layer.toGeoJSON();
             console.log(json);
           }
         });
         
         
      </script>
   </body>
</html>